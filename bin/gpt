#!/bin/zsh

###############################################################################
# GPT EXPERT MODE v4.3 — FULL ZSH / ZLE / OH-MY-ZSH ENVIRONMENT LOADER
###############################################################################

if [[ -z "$GPT_ENV_READY" ]]; then
  export GPT_ENV_READY=1
  exec zsh -i -c "
    source ~/.zshrc
    \"$0\" \"$@\"
  "
fi

###############################################################################
# LOAD ENV (.env)
###############################################################################
if [[ -f "$PWD/.env" ]]; then
  set -a
  source "$PWD/.env"
  set +a
fi

if [[ -z "$OPENAI_API_KEY" ]]; then
  echo "ERROR: OPENAI_API_KEY not set"
  exit 1
fi

###############################################################################
# BASIC SETTINGS
###############################################################################
setopt NO_NOMATCH
set -o emacs

LOGDIR=~/gpt_logs
MEMDB=~/.gpt_memory.db
PROJECT_ROOT=~/gpt_projects

mkdir -p "$LOGDIR" "$PROJECT_ROOT"

COLOR_USER="\033[1;34m"
COLOR_GPT="\033[1;35m"
COLOR_RESET="\033[0m"

MODEL="gpt-4.1"
SYSTEM_PROMPT="You are ChatGPT Expert Mode v4.3 in Assistant Mode."

###############################################################################
# SAFE ZLE INPUT
###############################################################################
safe_vared() {
  local VAR="$1"
  if ! zle >/dev/null 2>&1; then
    read "$VAR"
    return
  fi
  typeset -g "$VAR"
  vared "$VAR"
}

###############################################################################
# OPENAI
###############################################################################
OPENAI_CMD() {
  /opt/homebrew/bin/python3.11 -m openai -k "$OPENAI_API_KEY" "$@"
}

###############################################################################
# SQLITE SETUP
###############################################################################
if [[ ! -f "$MEMDB" ]]; then
  sqlite3 "$MEMDB" <<SQL
CREATE TABLE messages (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  project TEXT,
  role TEXT,
  content TEXT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE functions (
  name TEXT PRIMARY KEY,
  schema TEXT,
  handler TEXT
);
SQL
fi

###############################################################################
# MEMORY (REFINED)
###############################################################################
MEMORY_ENABLED=0
MEMORY_LIMIT=20

memory_add() {
  local role="$1"
  local content="$2"
  [[ "$MEMORY_ENABLED" -ne 1 || -z "$CURRENT_PROJECT" ]] && return

  sqlite3 "$MEMDB" <<SQL
INSERT INTO messages (project, role, content)
VALUES ('$CURRENT_PROJECT', '$role', '$content');
SQL

  memory_prune
}

memory_load() {
  [[ "$MEMORY_ENABLED" -ne 1 || -z "$CURRENT_PROJECT" ]] && return
  sqlite3 "$MEMDB" <<SQL
SELECT role || '|' || content
FROM messages
WHERE project='$CURRENT_PROJECT'
ORDER BY created_at DESC
LIMIT $MEMORY_LIMIT;
SQL
}

memory_stats() {
  [[ -z "$CURRENT_PROJECT" ]] && return
  sqlite3 "$MEMDB" \
    "SELECT COUNT(*) || ' messages stored' FROM messages WHERE project='$CURRENT_PROJECT';"
}

memory_prune() {
  [[ -z "$CURRENT_PROJECT" ]] && return
  sqlite3 "$MEMDB" <<SQL
DELETE FROM messages
WHERE id NOT IN (
  SELECT id FROM messages
  WHERE project='$CURRENT_PROJECT'
  ORDER BY created_at DESC
  LIMIT $MEMORY_LIMIT
)
AND project='$CURRENT_PROJECT';
SQL
}

###############################################################################
# PROJECTS
###############################################################################
projects_new() {
  mkdir -p "$PROJECT_ROOT/$1/files"
  CURRENT_PROJECT="$1"
  echo "Created and opened project: $1"
}

projects_open() {
  [[ -d "$PROJECT_ROOT/$1" ]] && CURRENT_PROJECT="$1" && echo "Opened: $1" || echo "Not found."
}

projects_list() {
  ls -1 "$PROJECT_ROOT"
}

###############################################################################
# HEADER
###############################################################################
echo "============================================================"
echo " GPT EXPERT MODE v4.3 — Assistant Mode + Strict Safety"
echo "============================================================"
echo "Model: $MODEL"
echo "Project Root: $PROJECT_ROOT"
echo "============================================================"

###############################################################################
# MAIN LOOP
###############################################################################
typeset -g USER_INPUT=""

while true; do
  print -n "\n${COLOR_USER}You:${COLOR_RESET} "
  safe_vared USER_INPUT
  [[ -z "$USER_INPUT" ]] && continue

  case "$USER_INPUT" in
    "/doctor")
      echo "---- GPTX Doctor ----"
      [[ -o interactive ]] && echo "Zsh Interactive: OK" || echo "Zsh Interactive: NO"
      [[ -n "$ZLE_VERSION" ]] && echo "ZLE: AVAILABLE" || echo "ZLE: NOT ATTACHED"
      [[ -d ~/.oh-my-zsh ]] && echo "Oh-My-Zsh: OK" || echo "Oh-My-Zsh: MISSING"
      [[ ${#OPENAI_API_KEY} -ge 40 ]] && echo "OPENAI_API_KEY: OK" || echo "OPENAI_API_KEY: INVALID"
      [[ -f "$MEMDB" ]] && echo "Memory DB: OK" || echo "Memory DB: MISSING"
      continue ;;
    "/projects list") projects_list; continue ;;
    "/projects new "*) projects_new "${USER_INPUT#*/projects new }"; continue ;;
    "/projects open "*) projects_open "${USER_INPUT#*/projects open }"; continue ;;
    "/memory on") MEMORY_ENABLED=1; echo "Memory ENABLED"; continue ;;
    "/memory off") MEMORY_ENABLED=0; echo "Memory DISABLED"; continue ;;
    "/memory show") memory_load | sed 's/^/• /'; continue ;;
    "/memory stats") memory_stats; continue ;;
    "/memory clear")
      sqlite3 "$MEMDB" "DELETE FROM messages WHERE project='$CURRENT_PROJECT';"
      echo "Memory CLEARED"
      continue ;;
  esac

  RAW=$(
    OPENAI_CMD api chat.completions.create \
      --model "$MODEL" \
      -g system "$SYSTEM_PROMPT" \
      -g user "$USER_INPUT"
  )

  echo "${COLOR_GPT}$RAW${COLOR_RESET}"

  # WRITE MEMORY ONLY ON SUCCESS
  if [[ -n "$RAW" && "$RAW" != *"Error"* ]]; then
    memory_add "user" "$USER_INPUT"
    memory_add "assistant" "$RAW"
  fi
done
