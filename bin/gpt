#!/bin/zsh

###############################################################################
# FORCE INTERACTIVE ZSH + ZLE (SAFE)
###############################################################################
if [[ -z "$GPTX_INTERACTIVE" ]]; then
  export GPTX_INTERACTIVE=1
  exec zsh -i "$0" "$@"
fi

###############################################################################
# RESOLVE REAL SCRIPT PATH (handles symlinks)
###############################################################################
SCRIPT_PATH="$(realpath "$0")"
SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"

###############################################################################
# LOAD ENV (.env) â€” script-relative
###############################################################################
if [[ -f "$SCRIPT_DIR/.env" ]]; then
  set -a
  source "$SCRIPT_DIR/.env"
  set +a
fi

###############################################################################
# BASIC SETTINGS
###############################################################################
setopt NO_NOMATCH
set -o emacs

trap_ctrl_c() {
  echo ""
  echo "ðŸ‘‹ Exiting GPTX."
  exit 0
}
trap trap_ctrl_c INT

COLOR_USER="\033[1;34m"
COLOR_GPT="\033[1;35m"
COLOR_RESET="\033[0m"

DEFAULT_MODEL="${DEFAULT_MODEL:-gpt-4.1}"
MODEL="$DEFAULT_MODEL"
MODEL_PROVIDER="openai"

###############################################################################
# ONE-SHOT MODE DETECTION
###############################################################################
ONE_SHOT_INPUT=""
[[ "$#" -gt 0 ]] && ONE_SHOT_INPUT="$*"

###############################################################################
# MODEL PROVIDER ROUTING
###############################################################################
detect_provider() {
  case "$MODEL" in
    gpt-*)    MODEL_PROVIDER="openai" ;;
    gemini-*) MODEL_PROVIDER="gemini" ;;
    claude-*) MODEL_PROVIDER="anthropic" ;;
    *)        MODEL_PROVIDER="openai" ;;
  esac
}

###############################################################################
# MODEL REGISTRY
###############################################################################
OPENAI_MODELS=(
  gpt-4.1
  gpt-4o
  gpt-4.1-mini
)

ANTHROPIC_MODELS=(
  claude-3-haiku-20240307
  claude-3-sonnet-20240229
)

GEMINI_MODELS=(
  gemini-pro
)

###############################################################################
# SAFE INPUT (ZLE-FIRST, NO ESCAPE GARBAGE)
###############################################################################
safe_vared() {
  local var="$1"

  if zle >/dev/null 2>&1; then
    vared "$var"
    return
  fi

  stty -echoctl 2>/dev/null
  read "$var"
}

###############################################################################
# PROVIDER REQUESTS
###############################################################################
OPENAI_CMD() {
  /opt/homebrew/bin/python3.11 -m openai -k "$OPENAI_API_KEY" "$@"
}

openai_request() {
  OPENAI_CMD api chat.completions.create \
    --model "$MODEL" \
    -g system "You are ChatGPT Expert Mode v4.4 in Assistant Mode." \
    -g user "$1"
}

gemini_request() {
  curl -s \
    "https://generativelanguage.googleapis.com/v1/models/gemini-pro:generateContent" \
    -H "Content-Type: application/json" \
    -H "x-goog-api-key: $GEMINI_API_KEY" \
    -d "{
      \"contents\": [{
        \"parts\": [{\"text\": \"$1\"}]
      }]
    }"
}

gemini_extract_text() {
  jq -r '.candidates[0].content.parts[].text' 2>/dev/null
}

anthropic_request() {
  [[ -z "$ANTHROPIC_API_KEY" ]] && {
    echo "ERROR: ANTHROPIC_API_KEY is not set"
    return 1
  }

  curl -s https://api.anthropic.com/v1/messages \
    -H "x-api-key: $ANTHROPIC_API_KEY" \
    -H "anthropic-version: 2023-06-01" \
    -H "content-type: application/json" \
    -d "{
      \"model\": \"$MODEL\",
      \"max_tokens\": 1024,
      \"messages\": [
        {\"role\": \"user\", \"content\": \"$1\"}
      ]
    }"
}

anthropic_extract_text() {
  jq -r '.content[] | select(.type=="text") | .text' 2>/dev/null
}

###############################################################################
# MODEL COMMANDS
###############################################################################
model_show() {
  detect_provider
  echo "Current model: $MODEL ($MODEL_PROVIDER)"
}

model_set() {
  [[ -z "$1" ]] && { echo "Usage: /model set MODEL"; return; }
  MODEL="$1"
  detect_provider
  echo "Model set to $MODEL ($MODEL_PROVIDER)"
}

model_list() {
  local mode="$1"

  if [[ "$mode" == "all" ]]; then
    echo ""
    echo "Available models (ALL PROVIDERS)"
    echo "---------------------------------------------"

    echo ""
    echo "OpenAI:"
    printf "â€¢ %s\n" "${OPENAI_MODELS[@]}"

    echo ""
    echo "Anthropic:"
    printf "â€¢ %s\n" "${ANTHROPIC_MODELS[@]}"

    echo ""
    echo "Gemini:"
    printf "â€¢ %s\n" "${GEMINI_MODELS[@]}"

    return
  fi

  detect_provider

  echo ""
  echo "Available models for provider: $MODEL_PROVIDER"
  echo "---------------------------------------------"

  case "$MODEL_PROVIDER" in
    openai)     printf "â€¢ %s\n" "${OPENAI_MODELS[@]}" ;;
    anthropic)  printf "â€¢ %s\n" "${ANTHROPIC_MODELS[@]}" ;;
    gemini)     printf "â€¢ %s\n" "${GEMINI_MODELS[@]}" ;;
  esac
}

###############################################################################
# STARTUP BANNER
###############################################################################
print_banner() {
  echo ""
  echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
  echo " GPTX | $([[ -n "$ONE_SHOT_INPUT" ]] && echo ONE-SHOT || echo INTERACTIVE)"
  echo " Provider: $MODEL_PROVIDER"
  echo " Model:    $MODEL"
  echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
  echo ""
}

###############################################################################
# MAIN EXECUTION
###############################################################################
detect_provider
print_banner

USER_INPUT=""

if [[ -n "$ONE_SHOT_INPUT" ]]; then
  USER_INPUT="$ONE_SHOT_INPUT"
else
  while true; do
    print -n "\n${COLOR_USER}You:${COLOR_RESET} "
    zle -I 2>/dev/null
    safe_vared USER_INPUT

    USER_INPUT="${USER_INPUT#"${USER_INPUT%%[![:space:]]*}"}"
    USER_INPUT="${USER_INPUT%"${USER_INPUT##*[![:space:]]}"}"
    [[ -z "$USER_INPUT" ]] && continue

    case "$USER_INPUT" in
      "/exit") exit 0 ;;
      "/model show") model_show; continue ;;
      "/model set "*) model_set "${USER_INPUT#*/model set }"; continue ;;
      "/model list all") model_list all; continue ;;
      "/model list")     model_list;     continue ;;
    esac

    detect_provider

    case "$MODEL_PROVIDER" in
      openai)
        RAW=$(openai_request "$USER_INPUT")
        ;;
      gemini)
        RAW=$(gemini_request "$USER_INPUT" | gemini_extract_text)
        ;;
      anthropic)
        RAW=$(anthropic_request "$USER_INPUT" | anthropic_extract_text)
        ;;
    esac

    echo "${COLOR_GPT}${RAW:-"(empty response)"}${COLOR_RESET}"
  done
fi
